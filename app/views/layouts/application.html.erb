<!DOCTYPE html>
<html>
  <head>
    <title>Sinistereo</title>
    <%= csrf_meta_tag %>
    <%= stylesheet_link_tag    "application", :media => "all" %>
    <%= javascript_include_tag "application" %>
    <!--BND added 6/13, trying to do Zen player -->
    <link rel="stylesheet" href="zen/style.css">
	<link rel="stylesheet" href="zen/css/zen.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>   
    <script type="text/javascript" src="zen/js/jquery.rotate.js"></script>
    <script type="text/javascript" src="zen/js/jquery.grab.js"></script> 
    <script type="text/javascript" src="zen/js/jquery.jplayer.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){    

        	var status = "stop";
      	var dragging = false;



      	// init

      	var player = $("#zen .player");

      	// player.jPlayer({
      	// 		ready: function () {
      	//       		$(this).jPlayer("setMedia", {
      	// 			mp3: "https://sinistereo.s3.amazonaws.com/uploads/song/audio/328/No_Time_For_Revenge_12.4.mp3" //#"audio/song.mp3",
      	//       		});
      	//     	},
      	//   	});  

      	function playSong(songUrl) {
      		player.jPlayer({
      			ready: function () {
      				$(this).jPlayer("setMedia", {
      					mp3: "" + songUrl
      				});
      			},

      		});
      	};

      	playSong("<%= j(@premium_songs.shuffle.first.audio.url.to_s) %>");




      	// preload, update, end

      	player.bind($.jPlayer.event.progress, function(event) {    

      		var audio = $('#zen audio').get(0);
      		var pc = 0;    

      		if ((audio.buffered != undefined) && (audio.buffered.length != 0)) {
      		 	pc = parseInt(((audio.buffered.end(0) / audio.duration) * 100), 10); 
      		  	displayBuffered(pc);
      		  	//console.log(pc);
      		  	if(pc >= 99) {
      		  		//console.log("loaded");
      		  		$('#zen .buffer').addClass("loaded");
      		  	}  
      		}        

      	});

      	//player.bind($.jPlayer.event.loadeddata, function(event) {    
      		//$('#zen .buffer').addClass("loaded");    
      	//});

      	player.bind($.jPlayer.event.timeupdate, function(event) { 
      		var pc = event.jPlayer.status.currentPercentAbsolute;
      		if (!dragging) { 
      	    	displayProgress(pc);
      		}
      	});
      // BND: we have to change this so when event.ended occurs, it loads the new one.
      	player.bind($.jPlayer.event.ended, function(event) {   
      		$('#zen .circle').removeClass( "rotate" );
      		$("#zen").removeClass( "play" );
      		$('#zen .progress').css({rotate: '0deg'});
      		status = "stop";
      	});





      	// play/pause

      	$("#zen .button").bind('mousedown', function() {
      		// not sure if this can be done in a simpler way.
      		// when you click on the edge of the play button, but button scales down and doesn't drigger the click,
      		// so mouseleave is added to still catch it.
      		$(this).bind('mouseleave', function() {
      			$(this).unbind('mouseleave');
      			onClick();
      		});
      	});

      	$("#zen .button").bind('mouseup', function() {
      		$(this).unbind('mouseleave');
      		onClick();
      	});


      	function onClick() {  		

              if(status != "play") {
      			status = "play";
      			$("#zen").addClass( "play" );
      			player.jPlayer("play");
      		} else {
      			$('#zen .circle').removeClass( "rotate" );
      			$("#zen").removeClass( "play" );
      			status = "pause";
      			player.jPlayer("pause");
      		}
      	};




      	// draggin

      	var clickControl = $('#zen .drag');

      	clickControl.grab({
      		onstart: function(){
      			dragging = true;
      			$('#zen .button').css( "pointer-events", "none" );

      		}, onmove: function(event){
      			var pc = getArcPc(event.position.x, event.position.y);
      			player.jPlayer("playHead", pc).jPlayer("play");
      			displayProgress(pc);

      		}, onfinish: function(event){
      			dragging = false;
      			var pc = getArcPc(event.position.x, event.position.y);
      			player.jPlayer("playHead", pc).jPlayer("play");
      			$('#zen .button').css( "pointer-events", "auto" );
      		}
      	});	






      	// functions

      	function displayProgress(pc) {
      		var degs = pc * 3.6+"deg"; 
      		$('#zen .progress').css({rotate: degs}); 		
      	}
      	function displayBuffered(pc) {
      		var degs = pc * 3.6+"deg"; 
      		$('#zen .buffer').css({rotate: degs}); 		
      	}

      	function getArcPc(pageX, pageY) { 
      		var	self	= clickControl,
      			offset	= self.offset(),
      			x	= pageX - offset.left - self.width()/2,
      			y	= pageY - offset.top - self.height()/2,
      			a	= Math.atan2(y,x);  

      			if (a > -1*Math.PI && a < -0.5*Math.PI) {
      		   a = 2*Math.PI+a; 
      		} 

      		// a is now value between -0.5PI and 1.5PI 
      		// ready to be normalized and applied   			
      		var pc = (a + Math.PI/2) / 2*Math.PI * 10;   

      		return pc;
      	}




      });
    </script>	
  </head>

  <body>
    <script type="text/javascript">
    setSong();
    </script>

    <div id="container">
      <header>
      <h1><%= link_to "SINISTEREO", root_url %> </h1>

      </header>
      
      <nav>
      <ul>
        <% if @user %>
          <% if @user.user_type == "Band" %>
            <li><%= link_to "Dashboard", artist_url(@user.bands.first), remote: true %></li>
          <% end %>
          <li><%= link_to "Account", user_url(@user.id), remote: true %></li>
          <li><%= link_to "Sign Out", signout_url %></li>
        <% else %>
          <li><%= link_to "Sign In", signin_url, remote: true %></li>
          <li><%= link_to "Sign Up", new_user_url, remote: true %></li>
        <% end %>
      </ul>
      </nav>
    </div>
    <div class="clear"></div>
    
    <body>
      

    <div id="content">
      <div class="window">
        <div class="new_playlist"></div>
        <div class="edit_playlist"></div>
        <div class="dashboard"></div>
        <div class="account"></div>
        <div class="signin"></div>
        <div class="signup"></div>
      </div>
      

      <% if flash[:notice].present? %>
        <p id="notice"><%= notice %></p>
      <% end %>

      <aside>
      <section>
      <div id='premium_blend'>
        <div>
          <h3> Premium Blend </p>
          </div>
          <% @premium_songs.each do |song| %>
            <ul>
              <div>
                <li><%= song.name %></li>
              </div>
            </ul>
          <% end %>
        </div>
        </section>

          <section>
            <% if @user %>
            <%= link_to "Add New Playlist", new_playlist_path, remote: true %>
              <div class="playlists">
              <% if @user.playlists.any? %>
                <% unless @playlists.empty? %>
                  <h2>Playlists</h2>
                    <% @playlists.each do |playlist| %>
                    <%= render 'playlist_bar', playlist: playlist %>
                    <% end %>
                    </div>
                <% end %>
              <% end %>
            <% end %>
            
          </section>
        </aside>

     <article>

	<div id="zen">
		<span class="player"></span>
		<span class="circle"></span>
		<span class="progress"></span>
		<span class="buffer"></span>
		<span class="drag"></span>
		<div class="button">
			<span class="icon play"></span>
			<span class="icon pause"></span>
		</div>
	</div>



      </article>

        </div>
        <%= yield %>
      </div>
      
      
    </body>

  </html
